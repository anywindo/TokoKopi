<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Corporate Panel - TokoKopi</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: #e5e7eb;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h2 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 1.5rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-light);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--primary);
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Content */
    .tab-content {
      display: none;
      background: var(--card-bg);
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tab-content.active {
      display: block;
    }

    /* Forms */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    input[type="text"],
    input[type="date"] {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.95rem;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background-color: #f9fafb;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    /* Utilities */
    .hidden {
      display: none;
    }

    .mt-4 {
      margin-top: 1rem;
    }

    .mb-4 {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2>Corporate Backend Panel</h2>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('laporan', this)">Laporan</button>
      <button class="tab-btn" onclick="switchTab('omzet', this)">Detail Omzet</button>
      <button class="tab-btn" onclick="switchTab('pemakaian', this)">Detail Pemakaian</button>
      <button class="tab-btn" onclick="switchTab('branch', this)">Branch</button>
    </div>

    <!-- TAB LAPORAN -->
    <div id="laporan" class="tab-content active">
      <div class="controls">
        <button onclick="loadDashboard()">Refresh Dashboard</button>
      </div>

      <h3 class="mb-4">Revenue Chart (Last 7 Days)</h3>
      <div id="revenue_chart_container"></div>

      <h3 class="mt-4 mb-4">Stock Average Usage (Last 7 Days)</h3>
      <div id="stock_avg_container"></div>

      <h3 class="mt-4 mb-4">Revenue by Branch</h3>
      <div id="branch_revenue_container"></div>
    </div>

    <!-- TAB OMZET -->
    <div id="omzet" class="tab-content">
      <div class="controls">
        <input id="o_date" type="date" />
        <input id="o_branch" type="text" placeholder="ID Branch" />
        <button onclick="loadOmzet()">Load Data</button>
      </div>
      <div id="omzet_table"></div>
    </div>

    <!-- TAB PEMAKAIAN -->
    <div id="pemakaian" class="tab-content">
      <div class="controls">
        <input id="p_date" type="date" />
        <input id="p_branch" type="text" placeholder="ID Branch" />
        <button onclick="loadPemakaian()">Load Data</button>
      </div>
      <div id="pemakaian_table"></div>
    </div>

    <!-- TAB BRANCH -->
    <div id="branch" class="tab-content">
      <div class="controls">
        <button onclick="loadBranch()">Refresh Branch List</button>
      </div>
      <div id="branch_table"></div>

      <h3 class="mt-4 mb-4">Add New Branch</h3>
      <div class="controls">
        <input id="br_name" type="text" placeholder="Branch Name" />
        <input id="br_alamat" type="text" placeholder="Address" />
        <button onclick="addBranch()">Add Branch</button>
      </div>
    </div>
  </div>

  <script>
    // <![CDATA[
    const API_URL = '../backend/corporate.php';

    function switchTab(tabId, btn) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      // Deactivate all buttons
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      // Activate button
      btn.classList.add('active');
    }

    async function fetchData(action, params = {}) {
      const url = new URL(API_URL, window.location.href);
      url.searchParams.append('action', action);
      for (const [key, value] of Object.entries(params)) {
        if (value) url.searchParams.append(key, value);
      }

      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.error) {
          alert('Error: ' + data.error);
          return null;
        }
        return data;
      } catch (error) {
        console.error('Fetch error:', error);
        alert('Failed to load data');
        return null;
      }
    }

    function createTable(data, columns) {
      if (!data || data.length === 0) return '<p class="text-light">No data available</p>';

      let html = '<table><thead><tr>';
      columns.forEach(col => html += `<th>${col.header}</th>`);
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
          html += `<td>${row[col.key] || '-'}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    async function loadDashboard() {
      const data = await fetchData('get_dashboard_data');
      if (!data) return;

      // Revenue Chart (Table for now)
      document.getElementById('revenue_chart_container').innerHTML = createTable(data.revenue_chart, [
        { header: 'Date', key: 'tanggal' },
        { header: 'Total Revenue', key: 'total' }
      ]);

      // Stock Avg
      const stockHtml = `
            <table>
                <thead>
                    <tr>
                        <th>Arabica</th><th>Robusta</th><th>Liberica</th><th>Decaf</th><th>Susu</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${parseFloat(data.stock_avg.arabica || 0).toFixed(2)}</td>
                        <td>${parseFloat(data.stock_avg.robusta || 0).toFixed(2)}</td>
                        <td>${parseFloat(data.stock_avg.liberica || 0).toFixed(2)}</td>
                        <td>${parseFloat(data.stock_avg.decaf || 0).toFixed(2)}</td>
                        <td>${parseFloat(data.stock_avg.susu || 0).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
        `;
      document.getElementById('stock_avg_container').innerHTML = stockHtml;

      // Branch Revenue
      document.getElementById('branch_revenue_container').innerHTML = createTable(data.branch_revenue, [
        { header: 'Branch Name', key: 'nama' },
        { header: 'Total Revenue', key: 'total' }
      ]);
    }

    async function loadOmzet() {
      const date = document.getElementById('o_date').value;
      const branch = document.getElementById('o_branch').value;

      const data = await fetchData('get_revenue_history', { date, branch });
      if (!data) return;

      document.getElementById('omzet_table').innerHTML = createTable(data, [
        { header: 'Date', key: 'tanggal' },
        { header: 'Revenue', key: 'omzet' },
        { header: 'Branch', key: 'branch_name' },
        { header: 'Reporter', key: 'pelapor' }
      ]);
    }

    async function loadPemakaian() {
      const date = document.getElementById('p_date').value;
      const branch = document.getElementById('p_branch').value;

      const data = await fetchData('get_stock_history', { date, branch });
      if (!data) return;

      document.getElementById('pemakaian_table').innerHTML = createTable(data, [
        { header: 'Date', key: 'tanggal' },
        { header: 'Branch', key: 'branch_name' },
        { header: 'Arabica', key: 'arabica' },
        { header: 'Robusta', key: 'robusta' },
        { header: 'Liberica', key: 'liberica' },
        { header: 'Decaf', key: 'decaf' },
        { header: 'Susu', key: 'susu' },
        { header: 'Reporter', key: 'pelapor' }
      ]);
    }

    async function loadBranch() {
      const data = await fetchData('get_branches');
      if (!data) return;

      document.getElementById('branch_table').innerHTML = createTable(data, [
        { header: 'ID', key: 'id_branch' },
        { header: 'Name', key: 'nama' },
        { header: 'Address', key: 'alamat' }
      ]);
    }

    async function addBranch() {
      const nama = document.getElementById('br_name').value;
      const alamat = document.getElementById('br_alamat').value;

      if (!nama || !alamat) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch(API_URL + '?action=add_branch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nama, alamat })
        });
        const result = await response.json();

        if (result.success) {
          alert('Branch added successfully');
          document.getElementById('br_name').value = '';
          document.getElementById('br_alamat').value = '';
          loadBranch(); // Refresh list
        } else {
          alert('Error: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to add branch');
      }
    }

    // Initial load
    loadDashboard();
    // ]]>
  </script>

</body>

</html>